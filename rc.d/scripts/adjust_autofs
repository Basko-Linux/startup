#!/bin/sh

# Source function library.
. /etc/init.d/functions

TABFILE=/etc/auto.tab

# Parse autofs config.
SourceIfNotEmpty /etc/sysconfig/autofs &&
	[ "$ENABLE" != no ] &&
	[ -s "$TABFILE" ] ||
	exit 0
	
devices="/mnt/cdrom /mnt/floppy /mnt/zip"
header="# Autogenerated configuration file for autofs"

cat >/etc/auto.master <<EOF
# Format of this file:
# mountpoint map options
# For details of the format look at autofs(8).

$header
/mnt/auto	$TABFILE	--timeout=5
EOF

echo "$header" >"$TABFILE"

# Loop over every line in /etc/fstab
(cat /etc/fstab; echo) | while read device mpoint fstype opts extra; do
	# Ignore empty lines and comments.
	[ -n "${device##\#*}" ] || continue

	for i in $devices; do
		for z in "" 2 3 4 5 6 7 8 9; do
			d="$i$z"
			if [ "$mpoint" = "$d" ]; then
				# Fetch mpoint's basename.
				mpoint="${mpoint##*/}"

				if echo "$opts" |fgrep -wqs ro; then
					fstype="$fstype,ro"
				else
					fstype="$fstype,umask=000"
				fi
				echo "$mpoint	-fstype=$fstype	:$device" >>"$TABFILE"
				ln -s "/mnt/auto/$mpoint" "$d/auto" &>/dev/null
				break 2
			fi
		done
	done
done
:
